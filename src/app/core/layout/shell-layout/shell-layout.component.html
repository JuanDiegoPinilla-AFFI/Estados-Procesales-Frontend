<!--
  Cambios (30-12-2025) - Santiago Obando:
  - Se agregó input editable de `Correo electrónico` al modal de soporte.
  - Se corrigió la estructura del `<nav>` que causaba NG5002 (Unexpected closing tag "nav").
  - Motivo: permitir enviar un email distinto desde el modal como reply-to en tickets.
-->
<div class="panel-layout" [class.sidebar-open]="sidebarOpen">
  <!-- OVERLAY MÓVIL -->
  @if (sidebarOpen) {
    <div class="overlay" (click)="toggleSidebar()"></div>
  }

  <!-- SIDEBAR -->
  <aside class="sidebar" [class.sidebar--open]="sidebarOpen">
    <div class="sidebar__logo">
      <picture>
        <source media="(min-width: 769px) and (max-width: 1024px)" srcset="/Affi.png">

        <img src="/logo_affi_20.png" alt="Logo" class="logo-img" />
      </picture>
    </div>

    <nav class="sidebar__nav">
      @for (section of menuSections; track section) {
        <div class="nav-section">
          <div class="nav-section__title">{{ section.title }}</div>
          @for (item of section.items; track item) {
            <a
              [routerLink]="item.route"
              [class.is-active]="isItemActive(item)"
              class="nav-link"
              (click)="closeSidebarOnMobile()">
              @if (item.icon) {
                <div class="nav-link__icon">
                  <i-feather [name]="item.icon"></i-feather>
                </div>
              }
              <span class="nav-link__text">{{ item.label }}</span>
              @if (item.badge) {
                <span class="nav-link__badge">{{ item.badge }}</span>
              }
            </a>
          }
        </div>
      }

      <div class="nav-section">
        <div class="nav-section__title">Sistema</div>
        <a class="nav-link" (click)="logout()">
          <div class="nav-link__icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
              <polyline points="16 17 21 12 16 7"/>
              <line x1="21" y1="12" x2="9" y2="12"/>
            </svg>
          </div>
          <span class="nav-link__text">Cerrar Sesión</span>
        </a>
      </div>
    </nav>

    <div class="sidebar__footer">
      <div class="promo-card">
        <div class="promo-card__title" style="display: flex; align-items: center; gap: 6px;">
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M12 3C8.962 3 6.5 5.462 6.5 8.5C6.5 10.346 7.36 11.824 8.39 12.93C9.108 13.703 9.5 14.414 9.5 15.25V16H14.5V15.25C14.5 14.414 14.892 13.703 15.61 12.93C16.64 11.824 17.5 10.346 17.5 8.5C17.5 5.462 15.038 3 12 3Z"
            stroke="currentColor"
            stroke-width="1.8"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="#FFE680"
          />
          <rect
            x="9"
            y="16"
            width="6"
            height="2.2"
            rx="0.6"
            fill="#E0E0E0"
            stroke="currentColor"
            stroke-width="1"
          />
          <rect
            x="9.2"
            y="18.4"
            width="5.6"
            height="1.8"
            rx="0.6"
            fill="#D0D0D0"
          />
          <path
            d="M10.5 21H13.5"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linecap="round"
          />
          <path
            d="M10 5.5C10.6 4.9 11.3 4.6 12.1 4.5"
            stroke="white"
            stroke-width="1.4"
            stroke-linecap="round"
          />
        </svg>
          Tips
        </div>
        <div class="promo-card__text">
          {{ currentTip }}
        </div>
      </div>
      <div class="version-badge">v1.0.0</div>
    </div>
  </aside>

  <!-- MAIN AREA -->
  <div class="main">
    <!-- TOP HEADER -->
    <header class="top-header">
      <button class="menu-btn" (click)="toggleSidebar()">
        <span class="menu-icon" [class.open]="sidebarOpen">
          <span></span>
          <span></span>
          <span></span>
        </span>
      </button>

      <!-- BREADCRUMB DINÁMICO -->
      <div class="breadcrumb">
        @for (item of breadcrumbs; track item; let last = $last) {
          <span
            class="breadcrumb__item"
            [class.breadcrumb__item--active]="last">
            {{ item.label }}
          </span>
          @if (!last) {
            <span class="breadcrumb__separator">/</span>
          }
        }
      </div>

      <div class="top-header__actions">
        <div class="user-info">
          <div class="user-info__details">
            <span class="user-info__name">{{ userName }}</span>
            <span class="user-info__role">{{ userRole }}</span>
          </div>
          <div class="user-avatar">
            <span>{{ userInitials }}</span>
          </div>
        </div>

        <button class="icon-btn icon-btn--help" title="Ayuda" (click)="openSupportModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
        </button>
        <button class="icon-btn icon-btn--logout" (click)="logout()" title="Cerrar sesión">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16 17 21 12 16 7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
        </button>
      </div>
    </header>

    @if (showSupportModal) {
      <div class="modal-overlay">
        <div class="modal-card">
          <div class="modal-header">
            <h3>Ticket de Soporte</h3>
            <button class="close-btn" (click)="closeSupportModal()">
              <i-feather name="x"></i-feather>
            </button>
          </div>
          
          <div class="modal-body">
            <p class="helper text-left mb-4 px-0">
              ¿Tienes algún problema o sugerencia? Envíanos un ticket y te responderemos al correo registrado.
            </p>

            <div class="form-group">
              <label>Correo electrónico *</label>
              <input [(ngModel)]="ticketData.email" class="field__input" placeholder="tu@correo.com">
              <small class="email-hint">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                  <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
                  A este correo te enviaremos la respuesta
            </small>
            </div>

            <div class="form-group">
              <label>Asunto *</label>
              <input [(ngModel)]="ticketData.subject" class="field__input" placeholder="Ej: Error al cargar procesos">
            </div>

            <div class="form-group">
              <label>Descripción del problema *</label>
              <textarea [(ngModel)]="ticketData.content" class="field__input" rows="4" placeholder="Describe detalladamente lo que sucede..."></textarea>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn--secondary" (click)="closeSupportModal()">Cancelar</button>
            <button class="btn btn--primary" (click)="sendTicket()" [disabled]="isSendingTicket">
              {{ isSendingTicket ? 'Enviando...' : 'Crear Ticket' }}
            </button>
          </div>
        </div>
      </div>
    }

    <!-- CONTENT -->
    <main class="main__content">
      <router-outlet></router-outlet>
    </main>

    <!-- FOOTER -->
    <footer class="footer">
      <div class="footer__text">Copyright ©2026 Affi latam</div>
      <div class="footer__links">
        <a href="#">Política de privacidad</a>
        <a href="#" class="footer__links--desktop">Términos de servicio</a>
        <a (click)="openSupportModal()" class="footer__links--desktop" style="cursor: pointer;">Soporte</a>
      </div>
    </footer>
  </div>
</div>