<div class="page">
  <div class="page__header">
    <div class="header-content">
      <div>
        <h2>Gestión de Usuarios</h2>
        <p>Administra el acceso, roles y permisos de la plataforma.
      </div>
      
      <div class="header-actions">
        <button class="btn btn--secondary" (click)="limpiarFiltros()">Limpiar Filtros</button>
        
        <button class="btn btn--primary" (click)="openExportModal()">
          <i-feather name="download" class="btn-icon-left"></i-feather>
          Exportar
        </button>

        <button class="btn btn--primary" (click)="openEditModal(null)">
          <i-feather name="plus" class="btn-icon-left"></i-feather>
          Crear Usuario
        </button>
      </div>

    </div>
  </div>

  @if (!loading) {
    <div class="stats-grid-overview">
      
      <div class="kpi-card">
        <div class="kpi-icon bg-blue-100 text-blue-700">
          <i-feather name="users"></i-feather>
        </div>
        <div class="kpi-content">
          <span class="kpi-label">Total Usuarios</span>
          <div class="kpi-value">{{ stats.total }}</div>
          <span class="kpi-subtext">Registrados en plataforma</span>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon bg-purple-100 text-purple-700">
          <i-feather name="shield"></i-feather>
        </div>
        <div class="kpi-content">
          <span class="kpi-label">Equipo Interno</span>
          <div class="kpi-value">{{ stats.staff }}</div>
          <div class="progress-mini">
            <div class="progress-fill bg-purple-500" [style.width.%]="stats.pctStaff"></div>
          </div>
          <span class="kpi-subtext">{{ stats.pctStaff }}% (Admin / Affi)</span>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon bg-orange-100 text-orange-700">
          <i-feather name="briefcase"></i-feather>
        </div>
        <div class="kpi-content">
          <span class="kpi-label">Clientes Inmobiliarias</span>
          <div class="kpi-value">{{ stats.clients }}</div>
           <div class="progress-mini">
            <div class="progress-fill bg-orange-500" [style.width.%]="stats.pctClients"></div>
          </div>
          <span class="kpi-subtext">{{ stats.pctClients }}% Usuarios Externos</span>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon bg-green-100 text-green-700">
          <i-feather name="activity"></i-feather>
        </div>
        <div class="kpi-content">
          <span class="kpi-label">Estado de Acceso</span>
          <div class="kpi-value-row">
            <span class="text-green-700">{{ stats.active }} Activos</span>
          </div>
           <div class="progress-multi">
            <div class="p-segment bg-green-500" [style.width.%]="stats.pctActive"></div>
            <div class="p-segment bg-red-200" [style.width.%]="stats.pctInactive"></div>
          </div>
          <span class="kpi-subtext">
            {{ stats.pctActive }}% Activos &bull; {{ stats.inactive }} Inactivos
          </span>
        </div>
      </div>

    </div>
  }

  <div class="card">
    <div class="filter-section">
      <div class="filters-grid">

        <label class="field full-width">
          <span class="field__label">Búsqueda Rápida</span>
          <div class="search-wrapper">
            <i-feather name="search" class="search-icon"></i-feather>
            <input 
              type="text" 
              [(ngModel)]="filtros.busquedaGeneral" 
              (ngModelChange)="applyFilters()"  placeholder="Buscar por nombre, NIT o email..." 
              class="field__input search-input"
            >
          </div>
        </label>

        <label class="field">
          <span class="field__label">NIT</span>
          <input 
            class="field__input" 
            type="text" 
            [(ngModel)]="filtros.nit" 
            (ngModelChange)="applyFilters()"  placeholder="Ej: 900053370"
          >
        </label>

        <label class="field">
          <span class="field__label">Nombre Inmobiliaria</span>
          <input 
            class="field__input" 
            type="text" 
            [(ngModel)]="filtros.nombreInmobiliaria" 
            (ngModelChange)="applyFilters()"  placeholder="Ej: AFFI"
          >
        </label>

        <div class="field custom-select-container">
          <span class="field__label">Rol</span>
          <div 
            class="custom-select" 
            (click)="toggleDropdown('rol', $event)" 
            [class.open]="activeDropdown === 'rol'"
          >
            <span class="selected-value" [class.placeholder]="!filtros.rol">
              {{ filtros.rol || 'Todos' }}
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="arrow">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          @if (activeDropdown === 'rol') {
            <div class="dropdown-menu">
              <div class="options-list">
                <div class="option" (click)="selectFilterOption('rol', '')" [class.selected]="filtros.rol === ''">Todos</div>
                @for (rol of listaRoles; track rol) {
                  <div class="option" (click)="selectFilterOption('rol', rol)" [class.selected]="filtros.rol === rol">{{ rol }}</div>
                }
              </div>
            </div>
          }
        </div>

        <div class="field custom-select-container">
          <span class="field__label">Estado</span>
          <div 
            class="custom-select" 
            (click)="toggleDropdown('estado', $event)" 
            [class.open]="activeDropdown === 'estado'"
          >
            <span class="selected-value" [class.placeholder]="!filtros.estado">
              {{ filtros.estado || 'Todos' }}
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="arrow">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          @if (activeDropdown === 'estado') {
            <div class="dropdown-menu">
              <div class="options-list">
                <div class="option" (click)="selectFilterOption('estado', '')" [class.selected]="filtros.estado === ''">Todos</div>
                @for (estado of listaEstados; track estado) {
                  <div class="option" (click)="selectFilterOption('estado', estado)" [class.selected]="filtros.estado === estado">{{ estado }}</div>
                }
              </div>
            </div>
          }
        </div>

      </div>
    </div>

    @if (loading) {
      <div class="helper"><div class="spinner"></div><p>Cargando datos...</p></div>
    }

    @if (!loading) {
      <div class="table-container">
        <div class="table-scroll">
          <table class="excel-table">
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Empresa / NIT</th>
                <th>Rol</th>
                <th>Estado</th>
                <th class="text-right">Acciones</th>
              </tr>
            </thead>
            <tbody>
              @for (user of paginatedUsers; track user._id) {
                <tr>
                  <td>
                    <div class="user-cell">
                      <div class="user-avatar-small">{{ user.name | slice:0:1 }}</div>
                      <div class="user-info">
                        <span class="user-name">{{ user.name }}</span>
                        <span class="user-email">{{ user.email }}</span>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="company-info">
                      <span class="company-name">{{ user.nombreInmobiliaria || 'N/A' }}</span>
                      @if (user.nit) { <span class="company-nit">NIT: {{ user.nit }}</span> }
                    </div>
                  </td>
                  <td>
                    <div class="role-selector-wrapper">
                      <select 
                        [ngModel]="user.role" 
                        (ngModelChange)="changeRole(user, $event)"
                        class="custom-select-sm">
                        @for (role of availableRoles; track role.value) {
                          <option [value]="role.value">{{ role.label }}</option>
                        }
                      </select>
                      
                      @if (hasCustomPermissions(user)) {
                        <span 
                          class="perm-badge" 
                          title="Este usuario tiene permisos diferentes al estándar de su rol">
                          Permisos Personalizados
                        </span>
                      }
                    </div>
                  </td>
                  <td>
                    <span (click)="toggleStatus(user)"
                      class="status-badge"
                      [class.status-badge--active]="user.isActive"
                      [class.status-badge--inactive]="!user.isActive">
                      {{ user.isActive ? 'Activo' : 'Inactivo' }}
                    </span>
                  </td>
                  <td class="text-right">
                    <div class="actions-cell">
                      <button (click)="openPermissionsModal(user)" class="btn-link" title="Gestionar Permisos">Permisos</button>
                      <button (click)="openEditModal(user)" class="btn-icon" title="Editar Información">
                        <i-feather name="edit-2"></i-feather>
                      </button>
                    </div>
                  </td>
                </tr>
              }
              @if (filteredUsers.length === 0 && !loading) {
                <tr><td colspan="5" class="text-center p-8 text-gray-500">No se encontraron usuarios.</td></tr>
              }
            </tbody>
          </table>
        </div>

        @if (filteredUsers.length > 0) {
          <div class="pagination">
            <button class="pagination__btn" [disabled]="currentPage === 1" (click)="prevPage()">← Anterior</button>
            <div class="pagination__info">
              <span>Página {{ currentPage }} de {{ totalPages }}</span>
              <div class="page-size-selector custom-select-container">
                <div class="custom-select" (click)="toggleDropdown('pageSize', $event)" [class.open]="activeDropdown === 'pageSize'">
                  <span class="selected-value">{{ itemsPerPage }} / pág</span>
                  <span class="arrow">▼</span>
                </div>
                @if (activeDropdown === 'pageSize') {
                  <div class="dropdown-menu dropdown-menu--up">
                    <div class="options-list">
                      @for (size of pageSizeOptions; track size) {
                        <div class="option" (click)="selectPageSize(size)" [class.selected]="itemsPerPage === size">{{ size }}</div>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
            <button class="pagination__btn" [disabled]="currentPage === totalPages" (click)="nextPage()">Siguiente →</button>
          </div>
        }
      </div>
    }
  </div>
</div>

@if (showExportModal) {
  <div class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <h3>Exportar Usuarios</h3>
        <button class="close-btn" (click)="closeExportModal()"><i-feather name="x"></i-feather></button>
      </div>
      <div class="modal-body">
        <p class="helper-text">Selecciona los datos a exportar:</p>
        
        <div class="columns-actions">
          <button class="btn-link" (click)="selectAllColumns(true)">Marcar todas</button>
          <button class="btn-link" (click)="selectAllColumns(false)">Desmarcar todas</button>
        </div>

        <div class="columns-grid">
          @for (col of exportColumns; track col.key) {
            <label class="permission-item" [class.active]="col.selected">
              <input type="checkbox" [checked]="col.selected" (change)="toggleColumn(col.key)">
              <span class="perm-label">{{ col.label }}</span>
            </label>
          }
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn--secondary" (click)="closeExportModal()" [disabled]="exportState !== 'idle'">
          Cancelar
        </button>

        <div class="export-buttons">
          <button class="btn btn--excel" (click)="exportToExcel()" [disabled]="exportState !== 'idle'">
            @if (exportState === 'excel') {
              <span class="spinner-loader"></span> Generando...
            } @else {
              <i-feather name="file-text"></i-feather> Excel
            }
          </button>

          <button class="btn btn--pdf" (click)="exportToPdf()" [disabled]="exportState !== 'idle'">
            @if (exportState === 'pdf') {
              <span class="spinner-loader"></span> Generando...
            } @else {
              <i-feather name="file-text"></i-feather> PDF
            }
          </button>
        </div>
      </div>
    </div>
  </div>
}

@if (showEditModal && selectedUser) {
  <div class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <h3>{{ isCreating ? 'Crear Nuevo Usuario' : 'Editar Usuario' }}</h3>
        <button class="close-btn" (click)="closeModals()"><i-feather name="x"></i-feather></button>
      </div>
      <div class="modal-body">
        
        <div class="form-group">
          <label>Nombre Completo *</label>
          <input [(ngModel)]="selectedUser.name" class="field__input" placeholder="Nombre del usuario">
        </div>

        <div class="form-group">
          <label>Correo Electrónico *</label>
          <input [(ngModel)]="selectedUser.email" class="field__input" placeholder="ejemplo@correo.com" [disabled]="!isCreating">
        </div>

        @if (isCreating) {
          <div class="form-group">
            <label>Contraseña *</label>
            <input [(ngModel)]="userPassword" type="password" class="field__input" placeholder="Mínimo 8 caracteres">
          </div>
          
          <div class="form-group bg-blue-50 p-3 rounded-md mb-4 border border-blue-100">
            <label class="text-blue-800">Tipo de Usuario</label>
            <select [ngModel]="selectedUser.role" 
                    (ngModelChange)="onRoleChange($event)" 
                    class="field__input mt-1">
              @for (role of availableRoles; track role.value) {
                <option [value]="role.value">{{ role.label }}</option>
              }
            </select>
          </div>
        }

        <div class="divider"></div>

        @if (selectedUser.role === 'inmobiliaria') {
          <div class="form-group relative">
            <label>Seleccionar Inmobiliaria *</label>
            
            <div class="custom-select-container">
              
              <div class="custom-select" 
                  [class.open]="isDropdownOpen" 
                  [class.disabled]="!isCreating && false" 
                  (click)="toggleDropdownInmo()">
                
                <span class="selected-value" [class.placeholder]="!selectedUser.nombreInmobiliaria">
                  @if (selectedUser.nombreInmobiliaria) {
                    {{ selectedUser.nombreInmobiliaria }} (NIT: {{ selectedUser.nit }})
                  } @else {
                    -- Buscar Inmobiliaria disponible --
                  }
                </span>
                <i-feather name="chevron-down" class="arrow"></i-feather>
              </div>

              @if (isDropdownOpen) {
                <div class="dropdown-menu">
                  
                  <div class="search-box" (click)="$event.stopPropagation()">
                    <i-feather name="search" class="search-icon"></i-feather>
                    <input type="text" 
                          [(ngModel)]="inmoSearchTerm" 
                          placeholder="Filtrar por nombre o NIT..."
                          autofocus>
                  </div>

                  <div class="options-list">
                    @for (inmo of searchableInmobiliarias; track inmo._id) {
                      <div class="option" 
                          (click)="selectInmobiliaria(inmo)"
                          [class.selected]="inmo._id === selectedInmoId">
                        <div class="option-name">{{ inmo.nombreInmobiliaria }}</div>
                        <div class="option-meta">
                          <span class="option-nit">NIT: {{ inmo.nit }}</span>
                          @if (inmo.emailRegistrado) { <span class="badge-current">(Actual)</span> }
                        </div>
                      </div>
                    }
                    
                    @if (searchableInmobiliarias.length === 0) {
                      <div class="option no-data">No se encontraron resultados.</div>
                    }
                  </div>
                </div>
              }
            </div>

            @if (filteredInmobiliarias.length === 0 && isCreating) {
              <span class="text-xs text-red-500 mt-1">No hay inmobiliarias disponibles sin cuenta.</span>
            }
          </div>
        }

        <div class="form-group">
          <label>Nombre Empresa (Autocompletado)</label>
          <input [(ngModel)]="selectedUser.nombreInmobiliaria" class="field__input bg-gray-50" readonly>
        </div>

        <div class="row">
          <div class="form-group">
            <label>NIT</label>
            <input [(ngModel)]="selectedUser.nit" class="field__input bg-gray-50" readonly>
          </div>
          <div class="form-group">
            <label>Código</label>
            <input [(ngModel)]="selectedUser.codigoInmobiliaria" class="field__input bg-gray-50" readonly>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn--secondary" (click)="closeModals()">Cancelar</button>
        <button class="btn btn--primary" (click)="saveEditUser()">
          {{ isCreating ? 'Crear Usuario' : 'Guardar Cambios' }}
        </button>
      </div>
    </div>
  </div>
}

@if (showPermissionsModal && selectedUser) {
  <div class="modal-overlay">
    <div class="modal-card modal-lg">
      <div class="modal-header">
        <h3>Gestionar Permisos</h3>
        <button class="close-btn" (click)="closeModals()"><i-feather name="x"></i-feather></button>
      </div>
      <div class="modal-body">
        <p class="helper-text">Permisos adicionales para <strong>{{ selectedUser.name }}</strong>.</p>
        <div class="permissions-grid">
          @for (perm of availablePermissions; track perm.key) {
            <label class="permission-item" [class.active]="hasPermission(perm.key)">
              <input type="checkbox" [checked]="hasPermission(perm.key)" (change)="togglePermission(perm.key)">
              <span class="perm-label">{{ perm.label }}</span>
            </label>
          }
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn--secondary" (click)="closeModals()">Cancelar</button>
        <button class="btn btn--primary" (click)="savePermissions()">Aplicar</button>
      </div>
    </div>
  </div>
}