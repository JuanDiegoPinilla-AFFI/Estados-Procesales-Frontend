<div class="page">
  <div class="page__header">
    <div class="header-content">
      <div>
        <h2>Inmobiliarias</h2>
        <p>Base de datos de clientes. Sincroniza masivamente desde Excel. &bull;
          Mostrando: {{ filteredInmobiliarias.length }} registros</p>
      </div>
      
      <div class="header-actions">
        <button class="btn btn--secondary" (click)="limpiarFiltros()">Limpiar Filtros</button>
        
        <button class="btn btn--primary" (click)="openExportModal()">
          <i-feather name="download" class="btn-icon-left"></i-feather>
          Exportar
        </button>

        <button class="btn btn--primary" 
                (click)="openImportModal()" 
                *ngIf="authService.hasPermission('inmo:import') || authService.isAdmin()">
          <i-feather name="upload-cloud" class="btn-icon-left"></i-feather>
          Importar Excel
        </button>
      </div>
    </div>
  </div>

  @if (!loading) {
    <div class="stats-grid-overview">
      
      <div class="kpi-card">
        <div class="kpi-icon bg-blue-100 text-blue-700">
          <i-feather name="database"></i-feather>
        </div>
        <div class="kpi-content">
          <span class="kpi-label">Total Inmobiliarias</span>
          <div class="kpi-value">{{ stats.total }}</div>
          <span class="kpi-subtext">Registros totales</span>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon bg-purple-100 text-purple-700">
          <i-feather name="user-check"></i-feather>
        </div>
        <div class="kpi-content">
          <span class="kpi-label">Con Usuario</span>
          <div class="kpi-value">{{ stats.conUsuario }}</div>
          <div class="progress-mini">
            <div class="progress-fill bg-purple-500" [style.width.%]="stats.pctConUsuario"></div>
          </div>
          <span class="kpi-subtext">{{ stats.pctConUsuario }}% Asignados</span>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon bg-orange-100 text-orange-700">
          <i-feather name="user-x"></i-feather>
        </div>
        <div class="kpi-content">
          <span class="kpi-label">Sin Usuario</span>
          <div class="kpi-value">{{ stats.sinUsuario }}</div>
           <div class="progress-mini">
            <div class="progress-fill bg-orange-500" [style.width.%]="stats.pctSinUsuario"></div>
          </div>
          <span class="kpi-subtext">{{ stats.pctSinUsuario }}% Pendientes</span>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon bg-green-100 text-green-700">
          <i-feather name="activity"></i-feather>
        </div>
        <div class="kpi-content">
          <span class="kpi-label">Estado Operativo</span>
          <div class="kpi-value-row">
            <span class="text-green-700">{{ stats.activos }} Activas</span>
          </div>
           <div class="progress-multi">
            <div class="p-segment bg-green-500" [style.width.%]="stats.pctActivos"></div>
            <div class="p-segment bg-red-200" [style.width.%]="stats.pctInactivos"></div>
          </div>
          <span class="kpi-subtext">
            {{ stats.pctActivos }}% Activas &bull; {{ stats.inactivos }} Inactivas
          </span>
        </div>
      </div>

    </div>
  }

  <div class="card">
    <div class="filter-section">
      <div class="filters-grid">

        <label class="field full-width">
          <span class="field__label">Búsqueda Rápida</span>
          <div class="search-wrapper">
            <i-feather name="search" class="search-icon"></i-feather>
            <input 
              type="text" 
              [(ngModel)]="filtros.busquedaGeneral" 
              (input)="currentPage = 1"
              placeholder="Buscar NIT, Código, Nombre, Ciudad..." 
              class="field__input search-input"
            >
          </div>
        </label>

        <label class="field">
          <span class="field__label">NIT</span>
          <input class="field__input" type="text" [(ngModel)]="filtros.nit" (input)="currentPage = 1" placeholder="Ej: 900053370">
        </label>

        <label class="field">
          <span class="field__label">Código</span>
          <input class="field__input" type="text" [(ngModel)]="filtros.codigo" (input)="currentPage = 1" placeholder="Ej: AFFI">
        </label>

        <label class="field">
          <span class="field__label">Nombre Inmobiliaria</span>
          <input class="field__input" type="text" [(ngModel)]="filtros.nombreInmobiliaria" (input)="currentPage = 1" placeholder="Ej: AFFI">
        </label>

        <div class="field custom-select-container">
          <span class="field__label">Departamento</span>
          <div class="custom-select" (click)="toggleDropdown('departamento', $event)" [class.open]="activeDropdown === 'departamento'">
            <span class="selected-value" [class.placeholder]="!filtros.departamento">{{ filtros.departamento || 'Todos' }}</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              @if (activeDropdown === 'departamento') {
                <polyline points="6 15 12 9 18 15"></polyline>
              } @else {
                <polyline points="6 9 12 15 18 9"></polyline>
              }
            </svg>
          </div>
          @if (activeDropdown === 'departamento') {
            <div class="dropdown-menu">
              <div class="options-list">
                <div class="option" (click)="selectFilterOption('departamento', '')">Todos</div>
                @for (depto of listaDepartamentos; track depto) {
                  <div class="option" (click)="selectFilterOption('departamento', depto)" [class.selected]="filtros.departamento === depto">{{ depto }}</div>
                }
              </div>
            </div>
          }
        </div>

        <div class="field custom-select-container">
          <span class="field__label">Ciudad</span>
          <div class="custom-select" (click)="toggleDropdown('ciudad', $event)" [class.open]="activeDropdown === 'ciudad'">
            <span class="selected-value" [class.placeholder]="!filtros.ciudad">{{ filtros.ciudad || 'Todas' }}</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              @if (activeDropdown === 'ciudad') {
                <polyline points="6 15 12 9 18 15"></polyline>
              } @else {
                <polyline points="6 9 12 15 18 9"></polyline>
              }
            </svg>
          </div>
          @if (activeDropdown === 'ciudad') {
            <div class="dropdown-menu">
              <div class="options-list">
                <div class="option" (click)="selectFilterOption('ciudad', '')">Todas</div>
                @for (ciudad of listaCiudades; track ciudad) {
                  <div class="option" (click)="selectFilterOption('ciudad', ciudad)" [class.selected]="filtros.ciudad === ciudad">{{ ciudad }}</div>
                }
              </div>
            </div>
          }
        </div>

        <div class="field">
          <span class="field__label">Inicio Fianza (Desde)</span>
          <input class="field__input" type="date" [(ngModel)]="filtros.fechaDesde" (input)="currentPage = 1">
        </div>
        
        <div class="field">
          <span class="field__label">Inicio Fianza (Hasta)</span>
          <input class="field__input" type="date" [(ngModel)]="filtros.fechaHasta" (input)="currentPage = 1">
        </div>

        <div class="field custom-select-container">
          <span class="field__label">Estado</span>
          <div class="custom-select" (click)="toggleDropdown('estado', $event)" [class.open]="activeDropdown === 'estado'">
            <span class="selected-value" [class.placeholder]="!filtros.estado">{{ filtros.estado || 'Todos' }}</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              @if (activeDropdown === 'estado') {
                <polyline points="6 15 12 9 18 15"></polyline>
              } @else {
                <polyline points="6 9 12 15 18 9"></polyline>
              }
            </svg>
          </div>
          @if (activeDropdown === 'estado') {
            <div class="dropdown-menu">
              <div class="options-list">
                <div class="option" (click)="selectFilterOption('estado', '')">Todos</div>
                @for (estado of listaEstados; track estado) {
                  <div class="option" (click)="selectFilterOption('estado', estado)" [class.selected]="filtros.estado === estado">{{ estado }}</div>
                }
              </div>
            </div>
          }
        </div>

        <div class="field custom-select-container">
          <span class="field__label">Usuario Asignado</span>
          <div class="custom-select" (click)="toggleDropdown('tieneUsuario', $event)" [class.open]="activeDropdown === 'tieneUsuario'">
            <span class="selected-value" [class.placeholder]="!filtros.tieneUsuario">{{ filtros.tieneUsuario || 'Todos' }}</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              @if (activeDropdown === 'tieneUsuario') {
                <polyline points="6 15 12 9 18 15"></polyline>
              } @else {
                <polyline points="6 9 12 15 18 9"></polyline>
              }
            </svg>
          </div>
          @if (activeDropdown === 'tieneUsuario') {
            <div class="dropdown-menu">
              <div class="options-list">
                <div class="option" (click)="selectFilterOption('tieneUsuario', '')">Todos</div>
                @for (tipo of listaTieneUsuario; track tipo) {
                  <div class="option" (click)="selectFilterOption('tieneUsuario', tipo)" [class.selected]="filtros.tieneUsuario === tipo">{{ tipo }}</div>
                }
              </div>
            </div>
          }
        </div>

      </div>
    </div>

    @if (loading) {
      <div class="helper"><div class="spinner"></div><p>Cargando datos...</p></div>
    }

    @if (!loading) {
      <div class="table-container">
        <div class="table-scroll">
          <table class="excel-table">
            <thead>
              <tr>
                <th>Inmobiliaria / Ubicación</th> <th>NIT / Código</th>
                <th>Contacto</th> <th>Inicio Fianza</th> <th>Usuario</th>
                <th>Estado</th>
                <th class="text-right">Acciones</th>
              </tr>
            </thead>
            <tbody>
              @for (inmo of paginatedInmobiliarias; track inmo._id) {
                <tr [class.opacity-50]="!inmo.isActive">
                  <td>
                    <div class="company-info">
                      <span class="company-name">{{ inmo.nombreInmobiliaria }}</span>
                      
                      <span class="company-nit" *ngIf="inmo.ciudad || inmo.departamento">
                        {{ inmo.ciudad || 'Sin ciudad' }} {{ inmo.departamento ? '(' + inmo.departamento + ')' : '' }}
                      </span>

                      @if(inmo.updatedAt) {
                        <span style="font-size: 0.65rem; color: #9ca3af; display: flex; align-items: center; gap: 4px; margin-top: 2px;">
                          <i-feather name="clock" style="width: 10px; height: 10px;"></i-feather>
                          {{ inmo.updatedAt | date:'dd/MM/yy' }} 
                          @if(inmo.modifiedBy) { &bull; {{ inmo.modifiedBy }} }
                        </span>
                      }
                    </div>
                  </td>
                  <td>
                    <div class="codes-cell" style="flex-direction: column; align-items: flex-start;">
                      <span class="code-pill">NIT: {{ inmo.nit }}</span>
                      <span class="code-pill code-pill--blue">COD: {{ inmo.codigo }}</span>
                    </div>
                  </td>
                 <td>
                    <div class="company-info">
                       @if(inmo.telefono) { 
                         <span class="contact-item">
                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="contact-icon">
                             <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 0 0-1.01.24l-1.57 1.97c-2.83-1.49-5.15-3.8-6.62-6.62l1.97-1.57c.23-.23.31-.56.25-.87-.36-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3.5 3 4.15 3 4.99 3 14.28 10.72 22 20.01 22c.84 0 1.49-.65 1.49-1.19V16.37c0-.55-.45-.99-.99-.99z"/>
                           </svg> 
                           {{ inmo.telefono }}
                         </span> 
                       }
                       @if(inmo.emailContacto) { 
                         <span class="contact-item contact-item--email" title="{{inmo.emailContacto}}">
                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="contact-icon">
                             <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                           </svg>
                           {{ inmo.emailContacto }}
                         </span> 
                       }
                    </div>
                  </td>
                  <td>
                    @if(inmo.fechaInicioFianza) {
                      <span class="text-sm text-gray-700 font-medium">{{ inmo.fechaInicioFianza | date:'dd/MM/yyyy' }}</span>
                    } @else {
                      <span class="text-xs text-gray-400">-</span>
                    }
                  </td>
                  <td>
                    @if (inmo.emailRegistrado) {
                      <div style="display: flex; flex-direction: column;">
                        <span class="text-sm text-gray-700 font-medium">{{ inmo.emailRegistrado }}</span>
                        @if(!inmo.isActive) { <span class="text-xs text-red-700" style="font-weight: bold;">BLOQUEADO</span> }
                      </div>
                    } @else {
                      <span class="text-xs text-gray-400 italic">Sin asignar</span>
                    }
                  </td>
                  <td>
                    <span (click)="toggleStatus(inmo)"
                      class="status-badge"
                      [class.status-badge--active]="inmo.isActive"
                      [class.status-badge--inactive]="!inmo.isActive">
                      {{ inmo.isActive ? 'Activo' : 'Inactivo' }}
                    </span>
                  </td>
                  <td class="text-right">
                    <div class="actions-cell">
                      <button (click)="openEditModal(inmo)" class="btn-icon" title="Editar">
                        <i-feather name="edit-2"></i-feather>
                      </button>
                    </div>
                  </td>
                </tr>
              }

              @if (filteredInmobiliarias.length === 0 && !loading) {
                <tr>
                  <td colspan="7" class="text-center p-8 text-gray-500">
                    No se encontraron inmobiliarias con los filtros aplicados.
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        @if (filteredInmobiliarias.length > 0) {
          <div class="pagination">
            <button class="pagination__btn" [disabled]="currentPage === 1" (click)="prevPage()">← Anterior</button>
            <div class="pagination__info">
              <span>Página {{ currentPage }} de {{ totalPages }}</span>
              <div class="page-size-selector custom-select-container">
                <div class="custom-select" (click)="toggleDropdown('pageSize', $event)" [class.open]="activeDropdown === 'pageSize'">
                  <span class="selected-value">{{ itemsPerPage }} / pág</span>
                  <span class="arrow">▼</span>
                </div>
                @if (activeDropdown === 'pageSize') {
                  <div class="dropdown-menu dropdown-menu--up">
                    <div class="options-list">
                      @for (size of pageSizeOptions; track size) {
                        <div class="option" (click)="selectPageSize(size)" [class.selected]="itemsPerPage === size">{{ size }}</div>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
            <button class="pagination__btn" [disabled]="currentPage === totalPages" (click)="nextPage()">Siguiente →</button>
          </div>
        }
      </div>
    }
  </div>
</div>

@if (showImportModal) {
  <div class="modal-overlay">
    <div class="modal-card modal-lg">
      <div class="modal-header">
        <h3>Sincronización Masiva</h3>
        <button class="close-btn" (click)="closeModals()"><i-feather name="x"></i-feather></button>
      </div>
      
      <div class="modal-body">
        @if (!isUploading && !importResult) {
          <div class="upload-area" 
               [class.drag-over]="dragOver"
               (dragover)="onDragOver($event)" 
               (dragleave)="onDragLeave($event)" 
               (drop)="onDrop($event)">
            
            <i-feather name="upload-cloud" class="upload-icon"></i-feather>
            <h4>Arrastra tu archivo Excel aquí</h4>
            <p>o haz clic para seleccionar</p>
            
            <input type="file" (change)="onFileSelected($event)" accept=".xlsx, .xls" id="fileInput" hidden>
            <label for="fileInput" class="btn btn--secondary mt-4">Seleccionar Archivo</label>
            
            <div class="file-info" *ngIf="currentFile">
              <i-feather name="file-text"></i-feather>
              <span>{{ currentFile.name }}</span>
            </div>

            <p class="helper-text mt-4">
              <strong>Nota:</strong> El archivo debe contener las columnas <code>NIT</code>, <code>CODIGO</code> y <code>NOMBRE</code>.<br>
              Opcionales: <code>FECHA_INICIO</code>, <code>DEPARTAMENTO</code>, <code>CIUDAD</code>, <code>TELEFONO</code>, <code>EMAIL</code>.<br>
              <span class="text-red-700">Los registros que no estén en el Excel serán <strong>INACTIVADOS</strong> y sus usuarios bloqueados.</span>
            </p>
          </div>
        }

        @if (isUploading) {
          <div class="uploading-state">
            <div class="spinner mb-4"></div>
            <h4>Procesando archivo...</h4>
            <div class="progress-bar-container"><div class="progress-bar" [style.width.%]="uploadProgress"></div></div>
            <p>{{ uploadProgress }}% Completado</p>
          </div>
        }

        @if (importResult) {
          <div class="results-state">
            <div class="success-icon-wrapper">
              <i-feather name="check" class="success-icon"></i-feather>
            </div>
            <h3 class="text-green-600 mb-4">¡Sincronización Completada!</h3>
            
            <div class="stats-grid">
              <div class="stat-card bg-blue-50 text-blue-700">
                <span class="stat-val">{{ importResult.resumen.procesados_excel }}</span>
                <span class="stat-label">Leídos</span>
              </div>
              <div class="stat-card bg-green-50 text-green-700">
                <span class="stat-val">{{ importResult.resumen.nuevos }}</span>
                <span class="stat-label">Nuevos</span>
              </div>
              <div class="stat-card bg-yellow-50 text-yellow-700">
                <span class="stat-val">{{ importResult.resumen.actualizados }}</span>
                <span class="stat-label">Actualizados</span>
              </div>
              <div class="stat-card bg-red-50 text-red-700">
                <span class="stat-val">{{ importResult.resumen.inactivados }}</span>
                <span class="stat-label">Inactivados</span>
              </div>
            </div>
          </div>
        }
      </div>

      <div class="modal-footer">
        <button class="btn btn--secondary" (click)="closeModals()">{{ importResult ? 'Cerrar' : 'Cancelar' }}</button>
        @if (!isUploading && !importResult) {
          <button class="btn btn--primary" (click)="uploadFile()" [disabled]="!currentFile">
            <i-feather name="refresh-cw" class="btn-icon-left"></i-feather> Iniciar Sincronización
          </button>
        }
      </div>
    </div>
  </div>
}

@if (showEditModal && selectedInmo) {
  <div class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <h3>Editar Inmobiliaria</h3>
        <button class="close-btn" (click)="closeModals()"><i-feather name="x"></i-feather></button>
      </div>
      <div class="modal-body">
        
        <div class="form-group">
          <label>Nombre Inmobiliaria</label>
          <input [(ngModel)]="selectedInmo.nombreInmobiliaria" class="field__input">
        </div>

        <div class="row">
          <div class="form-group">
            <label>NIT</label>
            <input [(ngModel)]="selectedInmo.nit" class="field__input">
          </div>
          <div class="form-group">
            <label>Código</label>
            <input [(ngModel)]="selectedInmo.codigo" class="field__input">
          </div>
        </div>
        <br>
        <div class="row">
          <div class="form-group">
            <label>Departamento</label>
            <input [(ngModel)]="selectedInmo.departamento" class="field__input">
          </div>
          <div class="form-group">
            <label>Ciudad</label>
            <input [(ngModel)]="selectedInmo.ciudad" class="field__input">
          </div>
        </div>
        <br>
        <div class="row">
          <div class="form-group">
            <label>Teléfono</label>
            <input [(ngModel)]="selectedInmo.telefono" class="field__input">
          </div>
          <div class="form-group">
            <label>Correo</label>
            <input [(ngModel)]="selectedInmo.emailContacto" class="field__input">
          </div>
        </div>
        <br>
        <div class="form-group">
          <label>Fecha Inicio Fianza</label>
          <input type="date" 
                 [ngModel]="selectedInmo.fechaInicioFianza | date:'yyyy-MM-dd'" 
                 (ngModelChange)="selectedInmo.fechaInicioFianza = $event"
                 class="field__input">
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn--secondary" (click)="closeModals()">Cancelar</button>
        <button class="btn btn--primary" (click)="saveEdit()">Guardar</button>
      </div>
    </div>
  </div>
}

@if (showExportModal) {
  <div class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <h3>Exportar Datos</h3>
        <button class="close-btn" (click)="closeExportModal()"><i-feather name="x"></i-feather></button>
      </div>
      <div class="modal-body">
        <p class="helper-text">Selecciona las columnas que deseas incluir en el reporte:</p>
        
        <div class="columns-actions">
          <button class="btn-link" (click)="selectAllColumns(true)">Marcar todas</button>
          <button class="btn-link" (click)="selectAllColumns(false)">Desmarcar todas</button>
        </div>

        <div class="columns-grid">
          @for (col of exportColumns; track col.key) {
            <label class="permission-item" [class.active]="col.selected">
              <input type="checkbox" [checked]="col.selected" (change)="toggleColumn(col.key)">
              <span class="perm-label">{{ col.label }}</span>
            </label>
          }
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn--secondary" (click)="closeExportModal()" [disabled]="exportState !== 'idle'">
          Cancelar
        </button>

        <div class="export-buttons">
          <button class="btn btn--excel" (click)="exportToExcel()" [disabled]="exportState !== 'idle'">
            @if (exportState === 'excel') {
              <span class="spinner-loader"></span> Generando...
            } @else {
              <i-feather name="file-text"></i-feather> Excel
            }
          </button>

          <button class="btn btn--pdf" (click)="exportToPdf()" [disabled]="exportState !== 'idle'">
            @if (exportState === 'pdf') {
              <span class="spinner-loader"></span> Generando...
            } @else {
              <i-feather name="file-text"></i-feather> PDF
            }
          </button>
        </div>
      </div>
    </div>
  </div>
}