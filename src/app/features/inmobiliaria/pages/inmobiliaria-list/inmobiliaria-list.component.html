<div class="page">
  <div class="page__header">
    <div class="header-content">
      <div>
        <h2>Inmobiliarias</h2>
        <p>Base de datos de clientes. Sincroniza masivamente desde Excel. &bull;
          Total: {{ filteredInmobiliarias.length }}</p>
      </div>
      
      <div class="header-actions">
        <button class="btn btn--secondary" (click)="limpiarFiltros()">Limpiar Filtros</button>
        <button class="btn btn--primary" 
                (click)="openImportModal()" 
                *ngIf="authService.hasPermission('inmo:import') || authService.isAdmin()">
          <i-feather name="upload-cloud" class="btn-icon-left"></i-feather>
          Importar Excel
        </button>
      </div>
    </div>
  </div>

  <div class="card">
    <!-- SECCIÓN DE FILTROS -->
    <div class="filter-section">
      <div class="filters-grid">

        <label class="field full-width">
          <span class="field__label">Búsqueda Rápida</span>
          <div class="search-wrapper">
            <i-feather name="search" class="search-icon"></i-feather>
            <input 
              type="text" 
              [(ngModel)]="filtros.busquedaGeneral" 
              (input)="currentPage = 1"
              placeholder="Buscar NIT, Código, Nombre o Email..." 
              class="field__input search-input"
            >
          </div>
        </label>

        <label class="field">
          <span class="field__label">NIT</span>
          <input 
            class="field__input" 
            type="text" 
            [(ngModel)]="filtros.nit" 
            (input)="currentPage = 1"
            placeholder="Ej: 900053370"
          >
        </label>

        <label class="field">
          <span class="field__label">Código</span>
          <input 
            class="field__input" 
            type="text" 
            [(ngModel)]="filtros.codigo" 
            (input)="currentPage = 1"
            placeholder="Ej: AFFI"
          >
        </label>

        <label class="field">
          <span class="field__label">Nombre Inmobiliaria</span>
          <input 
            class="field__input" 
            type="text" 
            [(ngModel)]="filtros.nombreInmobiliaria" 
            (input)="currentPage = 1"
            placeholder="Ej: AFFI"
          >
        </label>

        <div class="field custom-select-container">
          <span class="field__label">Estado</span>
          <div 
            class="custom-select" 
            (click)="toggleDropdown('estado', $event)" 
            [class.open]="activeDropdown === 'estado'"
          >
            <span class="selected-value" [class.placeholder]="!filtros.estado">
              {{ filtros.estado || 'Todos' }}
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              @if (activeDropdown === 'estado') {
                <polyline points="6 15 12 9 18 15"></polyline>
              } @else {
                <polyline points="6 9 12 15 18 9"></polyline>
              }
            </svg>
          </div>
          @if (activeDropdown === 'estado') {
            <div class="dropdown-menu">
              <div class="options-list">
                <div 
                  class="option" 
                  (click)="selectFilterOption('estado', '')" 
                  [class.selected]="filtros.estado === ''"
                >
                  Todos
                </div>
                @for (estado of listaEstados; track estado) {
                  <div 
                    class="option" 
                    (click)="selectFilterOption('estado', estado)" 
                    [class.selected]="filtros.estado === estado"
                  >
                    {{ estado }}
                  </div>
                }
              </div>
            </div>
          }
        </div>

        <div class="field custom-select-container">
          <span class="field__label">Usuario Asignado</span>
          <div 
            class="custom-select" 
            (click)="toggleDropdown('tieneUsuario', $event)" 
            [class.open]="activeDropdown === 'tieneUsuario'"
          >
            <span class="selected-value" [class.placeholder]="!filtros.tieneUsuario">
              {{ filtros.tieneUsuario || 'Todos' }}
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              @if (activeDropdown === 'tieneUsuario') {
                <polyline points="6 15 12 9 18 15"></polyline>
              } @else {
                <polyline points="6 9 12 15 18 9"></polyline>
              }
            </svg>
          </div>
          @if (activeDropdown === 'tieneUsuario') {
            <div class="dropdown-menu">
              <div class="options-list">
                <div 
                  class="option" 
                  (click)="selectFilterOption('tieneUsuario', '')" 
                  [class.selected]="filtros.tieneUsuario === ''"
                >
                  Todos
                </div>
                @for (tipo of listaTieneUsuario; track tipo) {
                  <div 
                    class="option" 
                    (click)="selectFilterOption('tieneUsuario', tipo)" 
                    [class.selected]="filtros.tieneUsuario === tipo"
                  >
                    {{ tipo }}
                  </div>
                }
              </div>
            </div>
          }
        </div>

      </div>
    </div>

    @if (loading) {
      <div class="helper"><div class="spinner"></div><p>Cargando datos...</p></div>
    }

    @if (!loading) {
      <div class="table-container">
        <div class="table-scroll">
          <table class="excel-table">
            <thead>
              <tr>
                <th>Inmobiliaria</th>
                <th>NIT</th>
                <th>Código</th>
                <th>Correo Usuario</th>
                <th>Estado</th>
                <th class="text-right">Acciones</th>
              </tr>
            </thead>
            <tbody>
              @for (inmo of paginatedInmobiliarias; track inmo._id) {
                <tr>
                  <td>
                    <div class="company-info">
                      <span class="company-name">{{ inmo.nombreInmobiliaria }}</span>
                      <span class="company-nit">Actualizado: {{ inmo.updatedAt | date:'shortDate' }}</span>
                    </div>
                  </td>
                  <td>
                    <div class="codes-cell">
                      <span class="code-pill">NIT: {{ inmo.nit }}</span>
                    </div>
                  </td>
                  <td>
                    <div class="codes-cell">
                      <span class="code-pill code-pill--blue">COD: {{ inmo.codigo }}</span>
                    </div>
                  </td>
                  <td>
                    @if (inmo.emailRegistrado) {
                      <span class="text-sm text-gray-700 font-medium">{{ inmo.emailRegistrado }}</span>
                    } @else {
                      <span class="text-xs text-gray-400 italic">Sin asignar</span>
                    }
                  </td>
                  <td>
                    <span (click)="toggleStatus(inmo)"
                      class="status-badge"
                      [class.status-badge--active]="inmo.isActive"
                      [class.status-badge--inactive]="!inmo.isActive">
                      {{ inmo.isActive ? 'Activo' : 'Inactivo' }}
                    </span>
                  </td>
                  <td class="text-right">
                    <div class="actions-cell">
                      <button (click)="openEditModal(inmo)" class="btn-icon" title="Editar">
                        <i-feather name="edit-2"></i-feather>
                      </button>
                    </div>
                  </td>
                </tr>
              }

              @if (filteredInmobiliarias.length === 0 && !loading) {
                <tr>
                  <td colspan="6" class="text-center p-8 text-gray-500">
                    No se encontraron inmobiliarias con los filtros aplicados.
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- PAGINACIÓN -->
        @if (filteredInmobiliarias.length > 0) {
          <div class="pagination">
            <button 
              class="pagination__btn" 
              [disabled]="currentPage === 1" 
              (click)="prevPage()"
            >
              ← Anterior
            </button>
            
            <div class="pagination__info">
              <span>Página {{ currentPage }} de {{ totalPages }}</span>
              
              <div class="page-size-selector custom-select-container">
                <div 
                  class="custom-select" 
                  (click)="toggleDropdown('pageSize', $event)" 
                  [class.open]="activeDropdown === 'pageSize'"
                >
                  <span class="selected-value">{{ itemsPerPage }} / pág</span>
                  <span class="arrow">▼</span>
                </div>
                @if (activeDropdown === 'pageSize') {
                  <div class="dropdown-menu dropdown-menu--up">
                    <div class="options-list">
                      @for (size of pageSizeOptions; track size) {
                        <div 
                          class="option" 
                          (click)="selectPageSize(size)" 
                          [class.selected]="itemsPerPage === size"
                        >
                          {{ size }}
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
            
            <button 
              class="pagination__btn" 
              [disabled]="currentPage === totalPages" 
              (click)="nextPage()"
            >
              Siguiente →
            </button>
          </div>
        }
      </div>
    }
  </div>
</div>

<!-- MODAL IMPORTACIÓN -->
@if (showImportModal) {
  <div class="modal-overlay">
    <div class="modal-card modal-lg">
      <div class="modal-header">
        <h3>Sincronización Masiva</h3>
        <button class="close-btn" (click)="closeModals()"><i-feather name="x"></i-feather></button>
      </div>
      
      <div class="modal-body">
        @if (!isUploading && !importResult) {
          <div class="upload-area" 
               [class.drag-over]="dragOver"
               (dragover)="onDragOver($event)" 
               (dragleave)="onDragLeave($event)" 
               (drop)="onDrop($event)">
            
            <i-feather name="upload-cloud" class="upload-icon"></i-feather>
            <h4>Arrastra tu archivo Excel aquí</h4>
            <p>o haz clic para seleccionar</p>
            
            <input type="file" (change)="onFileSelected($event)" accept=".xlsx, .xls" id="fileInput" hidden>
            <label for="fileInput" class="btn btn--secondary mt-4">Seleccionar Archivo</label>
            
            <div class="file-info" *ngIf="currentFile">
              <i-feather name="file-text"></i-feather>
              <span>{{ currentFile.name }}</span>
            </div>

            <p class="helper-text mt-4">
              <strong>Nota:</strong> El archivo debe contener las columnas <code>NIT</code>, <code>CODIGO</code> y <code>NOMBRE</code>. 
              Los registros que no estén en el Excel <strong>serán eliminados</strong>.
            </p>
          </div>
        }

        @if (isUploading) {
          <div class="uploading-state">
            <div class="spinner mb-4"></div>
            <h4>Procesando archivo...</h4>
            <div class="progress-bar-container">
              <div class="progress-bar" [style.width.%]="uploadProgress"></div>
            </div>
            <p>{{ uploadProgress }}% Completado</p>
          </div>
        }

        @if (importResult) {
          <div class="results-state">
            <div class="success-icon-wrapper">
              <i-feather name="check" class="success-icon"></i-feather>
            </div>
            <h3 class="text-green-600 mb-4">¡Sincronización Completada!</h3>
            
            <div class="stats-grid">
              <div class="stat-card bg-blue-50 text-blue-700">
                <span class="stat-val">{{ importResult.resumen.procesados_excel }}</span>
                <span class="stat-label">Leídos</span>
              </div>
              <div class="stat-card bg-green-50 text-green-700">
                <span class="stat-val">{{ importResult.resumen.nuevos }}</span>
                <span class="stat-label">Nuevos</span>
              </div>
              <div class="stat-card bg-yellow-50 text-yellow-700">
                <span class="stat-val">{{ importResult.resumen.actualizados }}</span>
                <span class="stat-label">Actualizados</span>
              </div>
              <div class="stat-card bg-red-50 text-red-700">
                <span class="stat-val">{{ importResult.resumen.eliminados }}</span>
                <span class="stat-label">Eliminados</span>
              </div>
            </div>
          </div>
        }
      </div>

      <div class="modal-footer">
        <button class="btn btn--secondary" (click)="closeModals()">
          {{ importResult ? 'Cerrar' : 'Cancelar' }}
        </button>
        
        @if (!isUploading && !importResult) {
          <button class="btn btn--primary" (click)="uploadFile()" [disabled]="!currentFile">
            <i-feather name="refresh-cw" class="btn-icon-left"></i-feather>
            Iniciar Sincronización
          </button>
        }
      </div>
    </div>
  </div>
}

<!-- MODAL EDITAR -->
@if (showEditModal && selectedInmo) {
  <div class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <h3>Editar Inmobiliaria</h3>
        <button class="close-btn" (click)="closeModals()"><i-feather name="x"></i-feather></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Nombre</label>
          <input [(ngModel)]="selectedInmo.nombreInmobiliaria" class="field__input">
        </div>
        <div class="row">
          <div class="form-group">
            <label>NIT</label>
            <input [(ngModel)]="selectedInmo.nit" class="field__input">
          </div>
          <div class="form-group">
            <label>Código</label>
            <input [(ngModel)]="selectedInmo.codigo" class="field__input">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn--secondary" (click)="closeModals()">Cancelar</button>
        <button class="btn btn--primary" (click)="saveEdit()">Guardar</button>
      </div>
    </div>
  </div>
}