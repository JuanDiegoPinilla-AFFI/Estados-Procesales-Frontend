<div class="dashboard-container">
  
  <div class="dash-header">
    <div>
      <h2>Tablero de Control</h2>
      <p class="subtitle">
        {{ nombreInmobiliaria | titlecase }} &bull; Actualizado: {{ fechaActual | date:'dd/MM/yyyy, h:mm a':'-0500' }}
      </p>
    </div>
    <div class="refresh-action">
      <button class="btn-refresh" (click)="loadData()">
        <i-feather name="refresh-cw" [class.spinning]="loading"></i-feather> Actualizar
      </button>
    </div>
  </div>

  @if (loading) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Procesando estadísticas...</p>
    </div>
  } @else {
    
    <div class="kpi-grid">
      <div class="kpi-card total">
        <div class="icon-wrapper"><i-feather name="layers"></i-feather></div>
        <div class="kpi-data">
          <span class="label">Total Cartera</span>
          <span class="value">{{ kpis.total }}</span>
        </div>
      </div>

      <div class="kpi-card prep">
        <div class="icon-wrapper"><i-feather name="file-text"></i-feather></div>
        <div class="kpi-data">
          <span class="label">En Preparación</span>
          <span class="value">{{ kpis.enPreparacion }}</span>
          <span class="sub-label">Recolección documental</span>
        </div>
      </div>

      <div class="kpi-card court">
        <div class="icon-wrapper"><i-feather name="briefcase"></i-feather></div>
        <div class="kpi-data">
          <span class="label">En Juzgado</span>
          <span class="value">{{ kpis.enJuzgado }}</span>
          <span class="sub-label">Radicados</span>
        </div>
      </div>

      <div class="kpi-card success">
        <div class="icon-wrapper"><i-feather name="award"></i-feather></div>
        <div class="kpi-data">
          <span class="label">Con Sentencia</span>
          <span class="value">{{ kpis.conSentencia }}</span>
          <span class="sub-label">Etapas avanzadas</span>
        </div>
      </div>

      <div class="kpi-card new-cases">
        <div class="icon-wrapper"><i-feather name="calendar"></i-feather></div>
        <div class="kpi-data">
          <span class="label">Nuevos este Mes</span>
          <span class="value">+{{ kpis.nuevosEsteMes }}</span>
          <span class="sub-label">Recibidos recientemente</span>
        </div>
      </div>
    </div>

    <div class="main-charts-grid">
      
      <div class="left-column">
        
        <div class="chart-card large">
          <div class="card-header">
            <h3>Flujo Procesal (Etapas)</h3>
          </div>
          <div class="card-body scrollable">
            <div class="bars-container">
              @for (stat of etapasStats; track stat.label) {
                <div class="bar-row">
                  <div class="bar-info">
                    <span class="bar-label">{{ stat.label }}</span>
                    <span class="bar-val">{{ stat.count }} ({{ stat.pct }}%)</span>
                  </div>
                  <div class="progress-track">
                    <div class="progress-fill" 
                         [style.width.%]="stat.pct"
                         [style.background-color]="stat.color"></div>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>

        <div class="chart-card">
          <div class="card-header"><h3>Ingreso Histórico (Por Año)</h3></div>
          <div class="card-body">
            <div class="timeline-chart">
              @for (time of timelineStats; track time.year) {
                <div class="time-col" title="{{ time.count }} procesos en {{ time.year }}">
                  <span class="time-val">{{ time.count }}</span>
                  <div class="time-bar" [style.height.%]="time.heightPct"></div>
                  <span class="time-lbl">{{ time.year }}</span>
                </div>
              }
              @if (timelineStats.length === 0) { <p class="no-data">Sin datos de fecha</p> }
            </div>
          </div>
        </div>

      </div>

      <div class="right-column">
        
        <div class="chart-card">
          <div class="card-header"><h3>Composición Cartera</h3></div>
          <div class="card-body flex-center">
            <div class="donut-chart" [style.background]="donutGradient">
              <div class="donut-hole">
                <span class="donut-total">{{ kpis.total }}</span>
                <span class="donut-label">Total</span>
              </div>
            </div>
            <div class="chart-legend">
              <div class="legend-item">
                <span class="dot court-dot"></span><span>En Juzgado</span>
              </div>
              <div class="legend-item">
                <span class="dot prep-dot"></span><span>En Preparación</span>
              </div>
            </div>
          </div>
        </div>

        <div class="chart-card">
          <div class="card-header"><h3>Top Ciudades</h3></div>
          <div class="card-body">
            <div class="mini-list">
              @for (city of ciudadesStats; track city.label) {
                <div class="mini-item">
                  <div class="mini-content">
                    <span class="mini-title">{{ city.label }}</span>
                    <div class="mini-bar"><div class="fill purple" [style.width.%]="city.pct"></div></div>
                  </div>
                  <span class="mini-count">{{ city.count }}</span>
                </div>
              }
            </div>
          </div>
        </div>

        <div class="chart-card">
          <div class="card-header"><h3>Juzgados Principales</h3></div>
          <div class="card-body">
            <div class="ranking-list">
              @for (desp of despachosStats; track desp.label; let i = $index) {
                <div class="rank-item">
                  <span class="rank-num">#{{ i + 1 }}</span>
                  <span class="rank-name" title="{{ desp.label }}">{{ desp.label }}</span>
                  <span class="rank-val">{{ desp.count }}</span>
                </div>
              }
            </div>
          </div>
        </div>

      </div>
    </div>
  }
</div>