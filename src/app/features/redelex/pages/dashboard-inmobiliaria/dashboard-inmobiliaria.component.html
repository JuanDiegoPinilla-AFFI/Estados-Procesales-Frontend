<div class="dashboard-container">
  
  <div class="dash-header">
    <div>
      <h2>Tablero de Control</h2>
      <p class="subtitle">
        {{ nombreInmobiliaria | titlecase }} &bull; 
        Actualizado: {{ fechaActual | date:'dd/MM/yyyy, h:mm a':'-0500' }}
      </p>
    </div>
    <div class="refresh-action">
      <button class="btn-refresh" (click)="loadData()">
        <i-feather name="refresh-cw" [class.spinning]="loading"></i-feather> Actualizar
      </button>
    </div>
  </div>

  @if (loading) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Procesando estadísticas...</p>
    </div>
  } @else {

    <section class="kpi-grid-global">
      <div class="kpi-card total">
        <div class="icon-wrapper"><i-feather name="layers"></i-feather></div>
        <div class="kpi-data">
          <span class="label">Obligaciones Cartera Avanzada</span>
          <span class="value">{{ kpis.total }}</span>
          <span class="sub-label">Procesos activos</span>
        </div>
      </div>

      <div class="kpi-card prep">
        <div class="icon-wrapper"><i-feather name="file-text"></i-feather></div>
        <div class="kpi-data">
          <span class="label">RECOLECCION Y VALIDACION DOCUMENTAL</span>
          <span class="value">{{ kpis.enPreparacion }}</span>
          <span class="sub-label">Recolección Doc.</span>
        </div>
      </div>

      <div class="kpi-card court">
        <div class="icon-wrapper"><i-feather name="briefcase"></i-feather></div>
        <div class="kpi-data">
          <span class="label">En Juzgado</span>
          <span class="value">{{ kpis.enJuzgado }}</span>
          <span class="sub-label">Trámite Judicial</span>
        </div>
      </div>

      <div class="kpi-card success">
        <div class="icon-wrapper"><i-feather name="award"></i-feather></div>
        <div class="kpi-data">
          <span class="label">Con Sentencia</span>
          <span class="value">{{ kpis.conSentencia }}</span>
          <span class="sub-label">Etapas Finales</span>
        </div>
      </div>
    </section>

    <div class="main-charts-grid">
      
      <div class="left-column">
        
        @if (ejecutivo.total > 0) {
          <section class="class-section">
            <div class="section-title">
              <h3>Procesos Ejecutivos</h3>
              <span class="badge badge-blue">{{ ejecutivo.total }} Procesos</span>
            </div>
            
            <div class="mini-kpis-row">
              <div class="mini-stat"><strong>{{ ejecutivo.prep }}</strong> <small>Recolección y Validación Documental</small></div>
              <div class="mini-stat"><strong>{{ ejecutivo.juzgado }}</strong> <small>Juzgado</small></div>
              <div class="mini-stat"><strong>{{ ejecutivo.sentencia }}</strong> <small>Sentencia</small></div>
            </div>

            <div class="bars-container">
              @for (stat of ejecutivo.flowStats; track stat.label) {
                <div class="bar-row">
                  <div class="bar-info">
                    <span class="bar-label">{{ stat.label }}</span>
                    <span class="bar-val">{{ stat.count }} ({{ stat.pct }}%)</span>
                  </div>
                  <div class="progress-track">
                    <div class="progress-fill" [style.width.%]="stat.pct" [style.background-color]="stat.color"></div>
                  </div>
                </div>
              }
            </div>
          </section>
        }

        @if (restitucion.total > 0) {
          <section class="class-section">
            <div class="section-title">
              <h3>Procesos de Restitución</h3>
              <span class="badge badge-blue">{{ restitucion.total }} Procesos</span>
            </div>

            <div class="mini-kpis-row">
              <div class="mini-stat"><strong>{{ restitucion.prep }}</strong> <small>Recolección y Validación Documental</small></div>
              <div class="mini-stat"><strong>{{ restitucion.juzgado }}</strong> <small>Juzgado</small></div>
              <div class="mini-stat"><strong>{{ restitucion.sentencia }}</strong> <small>Entrega</small></div>
            </div>

            <div class="bars-container">
              @for (stat of restitucion.flowStats; track stat.label) {
                <div class="bar-row">
                  <div class="bar-info">
                    <span class="bar-label">{{ stat.label }}</span>
                    <span class="bar-val">{{ stat.count }} ({{ stat.pct }}%)</span>
                  </div>
                  <div class="progress-track">
                    <div class="progress-fill" [style.width.%]="stat.pct" [style.background-color]="stat.color"></div>
                  </div>
                </div>
              }
            </div>
          </section>
        }
        
        </div>

      <div class="right-column">
        
        <div class="chart-card centered">
          <div class="card-header"><h3>Composición Cartera</h3></div>
          <div class="card-body flex-center">
            <div class="donut-chart" [style.background]="donutGradient">
              <div class="donut-hole">
                <span class="donut-total">{{ kpis.total }}</span>
                <span class="donut-label">Total</span>
              </div>
            </div>
            
            <div class="chart-legend">
              <div class="legend-item">
                <span class="dot prep-dot"></span>
                <span>Recolección ({{ pctPrep | percent:'1.0-0' }})</span>
              </div>
              <div class="legend-item">
                <span class="dot court-dot"></span>
                <span>Juzgado ({{ pctJuzgado | percent:'1.0-0' }})</span>
              </div>
              <div class="legend-item">
                <span class="dot sentencia-dot"></span>
                <span>Sentencia ({{ pctSentencia | percent:'1.0-0' }})</span>
              </div>
            </div>
          </div>
        </div>

        <div class="chart-card">
          <div class="card-header"><h3>Top 15 Ciudades con Mayor Número de Procesos</h3></div>
          <div class="card-body">
            <div class="mini-list">
              @for (city of ciudadesStats; track city.label) {
                <div class="mini-item">
                  <div class="mini-content">
                    <span class="mini-title">{{ city.label }}</span>
                    <div class="mini-bar">
                      <div class="fill purple" [style.width.%]="city.pct"></div>
                    </div>
                  </div>
                  <span class="mini-count">{{ city.count }}</span>
                </div>
              }
            </div>
          </div>
        </div>

      </div>
    </div>
  }
</div>